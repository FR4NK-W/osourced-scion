<div>
    <h1>AS TOPOLOGY</h1>
    Define topology file for AS:
    You only define the logical topology of the AS, i.e. you only need to specify the links for the edge routers.
    Endhosts are not specified.
    <br/>(Abstraction: naming and prefixing is provided, default values suggested: ip to 127.0.0.--/29 subnets,
    bandwidth, ports)
    <br/>
    <br/>
    <form class="form-horizontal" method="POST" action="/ad_manager/ads/generate_topology">
        {% csrf_token %}
            <div id="misc_fields" class="well">
            <b>AS mandatory fields:</b>
            <div class="control-group">
                <br/>
                <label class="control-label col-sm-2" for="inputIsCore">Is Core: </label>
                <div class="controls">
                    <input id="inputIsCore" name="inputIsCore" type="hidden" value="false" style="display: none;"
                           alt="get a value even for false checkbox"/>
                    <input id="inputIsCore" name="inputIsCore" class="shownCheckbox" type="checkbox" data-toggle='tooltip'
                           data-placement='right'
                           data-original-title="Is core checkbox: True, False (is of importance for Beacon, Certificate, Path server; stored as single entry in topo file)">
                </div>
            </div>
            <br/>
            <div class="control-group">
                <label class="control-label col-sm-2" for="inputDnsDomain">DNS Domain: </label>
                <div class="controls">
                    <input type="text" id="inputDnsDomain" name="inputDnsDomain"
                           placeholder="as{{ as_id }}-isd{{ isd_id }}.scion.">
                </div>
            </div>
            <div class="control-group">
                <label class="control-label col-sm-2" for="inputISD_AS">AS name: </label>
                <div class="controls">
                    <input type="text" id="inputISD_AS" name="inputISD_AS" placeholder="{{ isd_id|add:'-'|add:as_id }}"
                           value="{{ isd_id }}-{{as_id }}" alt="readonly">
                </div>
            </div>
            <div class="control-group">
                <label class="control-label col-sm-2" for="inputMTU">MTU: </label>
                <div class="controls">
                    <input type="text" id="inputMTU" name="inputMTU" placeholder="1472">
                </div>
            </div>
        </div>

        <br/>

        {% with 'Beacon Certificate Domain Path' as serverTypes %}
            {% for type in serverTypes.split %}
                <div class="control-group well">
                    <div class="chevron {% if forloop.counter0 > 0 %}collapsed{% endif %}" data-toggle="collapse"
                         href="#{{ type|lower }}Accordion"><span class="sectionTitle">{{ type }} servers</span></div>
                    <div id="{{ type|lower }}Accordion" class="collapse {% if forloop.counter0 == 0 %}in{% endif %}"
                         aria-expanded="true">
                        <br/>
                        <div class="{{ type }}Item">

                            <input type="text" id="input{{ type }}ServerType" name="input{{ type }}ServerType"
                                   value="{{ type|lower }}_server" style="display: none;">
                            <label class="control-label col-sm-2" for="input{{ type }}ServerName">Server name: </label>
                            <div class="controls">
                                <input type="text" id="input{{ type }}ServerName" name="input{{ type }}ServerName"
                                       value="{{ type|lower|slice:":1" }}s{{ isd_id }}-{{ as_id }}-1">
                            </div>

                            <label class="control-label col-sm-2" for="input{{ type }}ServerAddress">Address &
                                port: </label>
                            <div class="controls">
                                <input type="text" id="input{{ type }}ServerAddress" name="input{{ type }}ServerAddress"
                                       placeholder="127.0.0.{{ forloop.counter0|add:49 }}" value=""> :
                                <input id="input{{ type }}ServerPort" name="input{{ type }}ServerPort" class="inputPort"
                                       placeholder="{{ forloop.counter0|add:1025 }}" type="text">
                                <button class="btn btn-success btn-add pull-right" type="button"
                                        onclick="toggleInput(this);">
                                    <span class="glyphicon glyphicon-plus"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endwith %}

        <div class="control-group well">
            <div class="chevron" data-toggle="collapse" href="#routerAccordion"><span
                    class="sectionTitle">Edge routers: </span></div>
            <div id="routerAccordion" class="collapse in" aria-expanded="true">
                <div class="routerItem">
                    <label class="control-label col-sm-2" for="inputEdgeRouterName">Server name: </label>
                    <div class="controls">
                        <input type="text" id="inputEdgeRouterName" name="inputEdgeRouterName" value="er{{ isd_id }}-{{ as_id }}er1-19">
                    </div>
                    <label class="control-label col-sm-2" for="inputEdgeRouterAddress">Edge router: </label>
                    <div class="controls">
                        <input type="text" id="inputEdgeRouterAddress" name="inputEdgeRouterAddress"
                               placeholder="127.0.0.52/29">
                        <button class="btn btn-success btn-add pull-right" type="button"
                                onclick="toggleInput(this);">
                            <span class="glyphicon glyphicon-plus"></span>
                        </button>
                    </div>
                    <br/>
                    <div class="control-group">
                        <b>Interface parameters:</b>
                        <br/><br/>
                        <label class="control-label col-sm-2" for="inputInterfaceAddr">Interface address: </label>
                        <div class="controls">
                            <input type="text" id="inputInterfaceAddr" name="inputInterfaceAddr"
                                   placeholder="127.0.0.4/31">
                        </div>

                        <label class="control-label col-sm-2" for="inputInterfaceBandwidth">Interface
                            bandwidth: </label>
                        <div class="controls">
                            <input type="text" id="inputInterfaceBandwidth" name="inputInterfaceBandwidth"
                                   placeholder="1000">
                        </div>

                        <label class="control-label col-sm-2" for="inputInterfaceIFID">Address: </label>
                        <div class="controls">
                            <input type="text" id="inputInterfaceIFID" name="inputInterfaceIFID" placeholder="1">
                        </div>

                        <label class="control-label col-sm-2" for="inputInterfaceRemoteName">Name of the remote the link
                            connects: </label>
                        <div class="controls">
                            <input type="text" id="inputInterfaceRemoteName" name="inputInterfaceRemoteName"
                                   placeholder="1-19">
                        </div>
                        <br/>

                        <label class="control-label col-sm-2" for="inputInterfaceType">Type of the link: </label>
                        <div class="controls">
                            <select id="inputInterfaceType" name="inputInterfaceType" required>
                                <option value="PARENT" selected>PARENT</option>
                                <!--option value="ROUTING">ROUTING</option-->
                                <!-- ROUTING option gets added by javascript, only if the AS is core-->
                                <option value="PEER">PEER</option>
                                <option value="CHILD">CHILD</option>
                            </select>
                        </div>

                        <label class="control-label col-sm-2" for="inputInterfaceRemoteAddress">Remote address the link
                            connects to: </label>
                        <div class="controls">
                            <input type="text" id="inputInterfaceRemoteAddress" name="inputInterfaceRemoteAddress"
                                   placeholder="127.0.0.5/31">
                        </div>
                        <br/>

                        <label class="control-label col-sm-2" for="inputInterfaceRemotePort">Remote port the link
                            connects: </label>
                        <div class="controls">
                            <input type="text" id="inputInterfaceRemotePort" name="inputInterfaceRemotePort"
                                   class="inputPort" placeholder="50000">
                        </div>
                        <br/>

                        <label class="control-label col-sm-2" for="inputInterfaceOwnPort">Edge router port from which
                            the link connects: </label>
                        <div class="controls">
                            <input type="text" id="inputInterfaceOwnPort" name="inputInterfaceOwnPort"
                                   class="inputPort" placeholder="50000">
                        </div>
                        <br/>
                    </div>
                </div>
            </div>
        </div>

        <div class="control-group well">
            <div class="chevron collapsed" data-toggle="collapse" href="#sibraAccordion"><span class="sectionTitle">Sibra servers</span>
            </div>
            <div id="sibraAccordion" class="collapse" aria-expanded="true">
                <br/>
                <div class="sibraItem">

                    <input type="text" id="inputSibraServerType" name="inputSibraServerType" value="sibra_server"
                           style="display: none;">
                    <label class="control-label col-sm-2" for="inputSibraServerName">Server name: </label>
                    <div class="controls">
                        <input type="text" id="inputSibraServerName" name="inputSibraServerName" value="sb{{ isd_id }}-{{ as_id }}-1">
                    </div>

                    <label class="control-label col-sm-2" for="inputSibraServerAddress">Address & port: </label>
                    <div class="controls">
                        <input type="text" id="inputSibraServerAddress" name="inputSibraServerAddress"
                               placeholder="127.0.0.54"> :
                        <input id="inputSibraServerPort" name="inputSibraServerPort" class="inputPort"
                               placeholder="2048" type="text">
                        <button class="btn btn-success btn-add pull-right" type="button"
                                onclick="toggleInput(this);">
                            <span class="glyphicon glyphicon-plus"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="control-group well">
            <div class="chevron collapsed" data-toggle="collapse" href="#zookeeperAccordion"><span class="sectionTitle">Zookeeper servers</span>
            </div>
            <div id="zookeeperAccordion" class="collapse" aria-expanded="true">
                <br/>
                <div class="zookeeperItem">

                    <input type="text" id="inputZookeeperServerType" name="inputZookeeperServerType"
                           value="zookeeper_server" style="display: none;">
                    <label class="control-label col-sm-2" for="inputZookeeperServerName">Server name: </label>
                    <div class="controls">
                        <input type="text" id="inputZookeeperServerName" name="inputZookeeperServerName"
                               value="zk{{ isd_id }}-{{ as_id }}-1">
                    </div>

                    <label class="control-label col-sm-2" for="inputZookeeperServerAddress">Address: </label>
                    <div class="controls">
                        <input type="text" id="inputZookeeperServerAddress" name="inputZookeeperServerAddress"
                               placeholder="127.0.0.1">
                        <button class="btn btn-success btn-add pull-right" type="button"
                                onclick="toggleInput(this);">
                            <span class="glyphicon glyphicon-plus"></span>
                        </button>
                    </div>
                    <label class="control-label col-sm-2" for="inputZookeeperServerPort">Zookeeper port: </label>
                    <div class="controls">
                        <input type="text" id="inputZookeeperServerPort" name="inputZookeeperServerPort"
                               class="inputPort" placeholder="2181">
                    </div>
                </div>
            </div>
        </div>

        <br/>
        <div class="control-group">
            <button type="submit" class="btn">Save to topology file</button>
        </div>
    </form>

</div>

<script>
    function sanitize(loadenString) {
        loadenString = loadenString.replace(/&#39;/g, '"');
        loadenString = loadenString.replace(/True/g, '"True"');
        loadenString = loadenString.replace(/False/g, '"False"');
        return loadenString;
    }

    function parseTopology(reloadedTopology) {
        reloadedTopology = sanitize(reloadedTopology);
        reloadedTopology = JSON.parse(reloadedTopology);
        return reloadedTopology;
    }

    function setLoadedTopology(reloadedTopology) {
        var isCore = reloadedTopology['Core'];
        $('#inputIsCore.shownCheckbox').prop('checked', isCore);
        delete reloadedTopology['Core'];
        var dnsDomain = reloadedTopology['DnsDomain'];
        $('#inputDnsDomain').attr('value', dnsDomain);
        delete reloadedTopology['DnsDomain'];
        var mtu = reloadedTopology['MTU'];
        $('#inputMTU').attr('value', mtu);
        delete reloadedTopology['MTU'];
        var isd_as = reloadedTopology['ISD_AS'];
        delete reloadedTopology['ISD_AS'];

        for (var entryKey in reloadedTopology) {
            if (entryKey.endsWith("Servers")) {
                var entry = reloadedTopology[entryKey];
                var type = entryKey.slice(0,-7); // remove the 'Server' part
                if (type == 'DNS') {
                    type = 'Domain';
                }
                var typeValue = type.toLowerCase() + '_server';
                //$('#input'+type+'ServerType').attr('value', typeValue); // already set
                var name = Object.keys(entry)[0];
                $('#input'+type+'ServerName').attr('value', name);
                var server = entry[name];
                var address = server['Addr']
                $('#input'+type+'ServerAddress').attr('value', address);

                // remove entry
                delete reloadedTopology[entryKey]
            }
        }

        for (var edgeRouterKey in reloadedTopology['EdgeRouters']) {
            var edgeRouter = reloadedTopology['EdgeRouters'][edgeRouterKey];
            var name = edgeRouterKey;
            $('#inputEdgeRouterName').attr('value', name);
            var address = edgeRouter['Addr'];
            $('#inputEdgeRouterAddress').attr('value', address);

            var interface = edgeRouter['Interface'];
            for (var interfaceKey in interface) {
                var value = interface[interfaceKey];
                switch(interfaceKey) {
                    case 'ISD_AS':
                        $('#inputInterfaceRemoteName').attr('value', value);
                        break;
                    case 'LinkType':
                        $('#inputInterfaceType').attr('value', value);
                        break;
                    case 'ToAddr':
                        $('#inputInterfaceRemoteAddress').attr('value', value);
                        break;
                    case 'ToUdpPort':
                        $('#inputInterfaceRemotePort').attr('value', value);
                        break;
                    case 'UdpPort':
                        $('#inputInterfaceOwnPort').attr('value', value);
                        break;
                    default: // Addr, Bandwidth, IFID
                        $('#inputInterface'+interfaceKey).attr('value', value);
                }
            }
        }

        delete reloadedTopology['EdgeRouters'];

        var zookeepers = reloadedTopology['Zookeepers'];

        for (var zkKey in zookeepers) {
            var server = zookeepers[zkKey]; //inputZookeeperServerType
            //$('#inputZookeeperServerType').attr('value', 'zookeeper_server'); // already set
            var address = server['Addr'];
            $('#inputZookeeperServerAddress').attr('value', address);
            var port = server['Port'];
            $('#inputZookeeperServerPort').attr('value', port);
        }
    }

    reloadedTopology = '{{ reloaded_topology }}';
    reloadedTopology = parseTopology(reloadedTopology);
    setLoadedTopology(reloadedTopology);
</script>

