# USER_ISD_ID=17 USER_AS_ID=ffaa_1_xxx docker-compose -f docker-compose_MIN.yml up; find /run/shm/dispatcher /run/shm/sciond -type s -print0 | xargs -r0 rm -v
version: "3"
services:
  zookeeper:
    image: zookeeper:latest
    network_mode: "host"
    restart: always
    environment:
      ZOO_USER: "$LOGNAME"
      ZOO_DATA_DIR: "/var/lib/zookeeper"
      ZOO_DATA_LOG_DIR: "/dev/shm/zookeeper"
    volumes:
      - "/etc/passwd:/etc/passwd:ro"
      - "/etc/group:/etc/group:ro"
      - "./zoo-container.cfg:/conf/zoo.cfg"
      - "/var/lib/docker-zk:/var/lib/zookeeper"
      - "/run/shm/docker-zk:/dev/shm/zookeeper"
  dispatcher:
    entrypoint: /bin/bash -c '/sbin/ldconfig /usr/local/lib/; /sbin/su-exec /app/dispatcher'
    image: scion_dispatcher
    network_mode: "host"
    environment:
      SU_EXEC_USERSPEC: "$LOGNAME"
    volumes:
      - "/etc/passwd:/etc/passwd:ro"
      - "/etc/group:/etc/group:ro"
      - "/run/shm/dispatcher:/run/shm/dispatcher"
      - "../gen/dispatcher:/share/conf"
      - "../logs:/share/logs"
  border:
    image: scion_border
    network_mode: "host"
    environment:
      SU_EXEC_USERSPEC: "$LOGNAME"
    volumes:
      - "/etc/passwd:/etc/passwd:ro"
      - "/etc/group:/etc/group:ro"
      - "../gen/ISD${USER_ISD_ID}/AS${USER_AS_ID}/br${USER_ISD_ID}-${USER_AS_ID}-1:/share/conf"
      - "../logs:/share/logs"
    command: ["-id=br${USER_ISD_ID}-${USER_AS_ID}-1", "-prom=[127.0.0.49]:30093"]
#  sig:
#    image: scion_sig
#    network_mode: "host"
#    restart: on-failure # FIXME(worxli) #1621: Restarts the SIG when SCIOND was too slow
#    depends_on:
#      - sciond
#      - dispatcher
#    cap_add:
#      - NET_ADMIN
#    environment:
#      SU_EXEC_USERSPEC: "$LOGNAME"
#    volumes:
#      - "/etc/passwd:/etc/passwd:ro"
#    command: ["-id=sig1", "-config=/share/sig/01-loadfromfile.json", "-log.dir=logs", "-log.level=debug", "-ip=127.0.0.1", "-ia=1-ff00_0_110-1", "-sciond=/run/shm/sciond/sd1-ff00_0_110.sock", "-prom=:9504"]
  sciond:
    image: scion_sciond_py
    depends_on:
      - dispatcher
    environment:
      SU_EXEC_USERSPEC: "$LOGNAME"
    volumes:
      - "/etc/passwd:/etc/passwd:ro"
      - "/etc/group:/etc/group:ro"
      - "/run/shm/dispatcher:/run/shm/dispatcher"
      - "/run/shm/sciond:/run/shm/sciond"
      - "../gen/ISD${USER_ISD_ID}/AS${USER_AS_ID}/endhost:/share/conf:ro"
      - "../gen-cache:/share/gen-cache:ro"
      - "../logs:/share/logs"
    command: ["--api-addr", "/run/shm/sciond/sd${USER_ISD_ID}-${USER_AS_ID}.sock", "--log_dir=/share/logs", "sd${USER_ISD_ID}-${USER_AS_ID}", "conf"]
  path_py:
    image: scion_path_py
    depends_on:
      - sciond
      - dispatcher
      - zookeeper
    network_mode: "host"
    environment:
      SU_EXEC_USERSPEC: "$LOGNAME"
    volumes:
      - "/etc/passwd:/etc/passwd:ro"
      - "/etc/group:/etc/group:ro"
      - "/run/shm/dispatcher:/run/shm/dispatcher"
      - "/run/shm/sciond:/run/shm/sciond"
      - "../gen/ISD${USER_ISD_ID}/AS${USER_AS_ID}/ps${USER_ISD_ID}-${USER_AS_ID}-1:/share/conf:ro"
      - "../gen-cache:/share/gen-cache:ro"
      - "../logs:/share/logs"
    command: ["--prom", "[127.0.0.55]:30080", "ps${USER_ISD_ID}-${USER_AS_ID}-1", "conf"]
  beacon:
    image: scion_beacon_py
    depends_on:
      - sciond
      - dispatcher
      - zookeeper
    network_mode: "host"
    environment:
      SU_EXEC_USERSPEC: "$LOGNAME"
    volumes:
      - "/etc/passwd:/etc/passwd:ro"
      - "/etc/group:/etc/group:ro"
      - "/run/shm/dispatcher:/run/shm/dispatcher"
      - "/run/shm/sciond:/run/shm/sciond"
      - "../gen/ISD${USER_ISD_ID}/AS${USER_AS_ID}/bs${USER_ISD_ID}-${USER_AS_ID}-1:/share/conf:ro"
      - "../gen-cache:/share/gen-cache:ro"
      - "../logs:/share/logs"
    command: ["--prom", "[127.0.0.53]:30092", "bs${USER_ISD_ID}-${USER_AS_ID}-1", "conf"]
  cert:
    image: scion_cert
    depends_on:
      - sciond
      - dispatcher
      - zookeeper
    environment:
      SU_EXEC_USERSPEC: "$LOGNAME"
    volumes:
      - "/etc/passwd:/etc/passwd:ro"
      - "/etc/group:/etc/group:ro"
      - "/run/shm/dispatcher:/run/shm/dispatcher"
      - "/run/shm/sciond:/run/shm/sciond"
      - "../gen/ISD${USER_ISD_ID}/AS${USER_AS_ID}/cs${USER_ISD_ID}-${USER_AS_ID}-1:/share/conf"
      - "../gen-cache:/share/gen-cache:ro"
      - "../logs:/share/logs"
    command: ["-prom", "[127.0.0.54]:30082", "-id", "cs${USER_ISD_ID}-${USER_AS_ID}-1", "-confd", "conf", "-sciond", "/run/shm/sciond/sd${USER_ISD_ID}-${USER_AS_ID}.sock", "-cached", "/share/gen-cache"]
